# Database Migrations

This folder contains Alembic database migrations for the DigitalGrub Indexer project.

## Structure

```
migrations/
├── env.py                  # Alembic environment configuration
├── script.py.mako         # Template for new migrations
└── versions/              # Migration version files
    └── 001_add_indexing_columns.py  # Initial migration
```

## Quick Start

### 1. Run Migrations (Recommended)

The easiest way to run migrations:

```bash
python migrate.py
```

Or use the full setup script:

```bash
python setup_db.py
```

### 2. Check Current Version

```bash
python migrate.py current
```

### 3. View Migration History

```bash
python migrate.py history
```

## Manual Alembic Commands

If you prefer using Alembic directly:

```bash
# Upgrade to latest
alembic upgrade head

# Show current revision
alembic current

# Show history
alembic history

# Downgrade one version
alembic downgrade -1

# Create new migration (autogenerate)
alembic revision --autogenerate -m "your message"
```

## What the Initial Migration Does

The first migration (`001_add_indexing_columns.py`) adds:

1. **`index_status` column** (VARCHAR(50))
   - Tracks if a record has been indexed
   - Values: NULL, 'indexed', 'error', etc.

2. **`created_at` column** (TIMESTAMP)
   - Automatically set when record is created
   - Default: CURRENT_TIMESTAMP

3. **`updated_at` column** (TIMESTAMP)
   - Automatically updated when record changes
   - Default: CURRENT_TIMESTAMP

4. **Indexes** for better query performance:
   - `idx_jobs_index_status`
   - `idx_jobs_updated_at`
   - `idx_tnnews_index_status`
   - `idx_tnnews_updated_at`
   - `idx_aijobs_index_status`
   - `idx_aijobs_updated_at`

These columns are added to:
- `jobs` table
- `tnnews` table
- `aijobs` table

## Creating New Migrations

When you modify models in `models.py`:

```bash
# Auto-generate migration from model changes
python migrate.py create "describe your changes"

# Or use alembic directly
alembic revision --autogenerate -m "describe your changes"
```

Then review and edit the generated file in `migrations/versions/` before running it.

## Troubleshooting

### "Can't locate revision identified by"

This means your database is out of sync. Options:

1. **Reset (development only)**:
   ```sql
   DROP TABLE alembic_version;
   ```
   Then run migrations again.

2. **Stamp current version**:
   ```bash
   alembic stamp head
   ```

### "Column already exists"

The migration script is designed to handle this gracefully with try/except blocks. It will skip columns that already exist.

### Connection errors

Check your `.env` file:
- `DB_HOST`
- `DB_PORT`
- `DB_NAME`
- `DB_USER`
- `DB_PASSWORD`

## Best Practices

1. **Always review autogenerated migrations** before running them
2. **Test migrations on a development database first**
3. **Backup production database before running migrations**
4. **Never edit migration files after they've been applied**
5. **Use descriptive names** when creating migrations

## Rolling Back

To undo the last migration:

```bash
python migrate.py downgrade
```

Or with Alembic:

```bash
alembic downgrade -1
```
